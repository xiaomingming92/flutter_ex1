# ä¿¡æ¯è„±æ•å’Œæ•æ„Ÿä¿¡æ¯æŸ¥çœ‹å®¡è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†åç«¯ç³»ç»Ÿä¸­ä¿¡æ¯è„±æ•å¤„ç†å’Œæ•æ„Ÿä¿¡æ¯æŸ¥çœ‹å®¡è®¡æœºåˆ¶çš„è®¾è®¡ä¸å®ç°ï¼Œç¡®ä¿ç”¨æˆ·éšç§ä¿æŠ¤å’Œæ•°æ®å®‰å…¨åˆè§„ã€‚

## ğŸ”’ ä¿¡æ¯è„±æ•ç­–ç•¥

### 1. è„±æ•æ•°æ®åˆ†ç±»

#### 1.1 ä¸€çº§æ•æ„Ÿä¿¡æ¯ï¼ˆä¸¥æ ¼è„±æ•ï¼‰
- **æ‰‹æœºå·ç **: `138****5678` (ä¿ç•™å‰3ä½å’Œå4ä½ï¼Œä¸­é—´4ä½ç”¨*æ›¿æ¢)
- **èº«ä»½è¯å·ç **: `11010119900101****` (ä¿ç•™å‰6ä½å’Œå4ä½)
- **é“¶è¡Œå¡å·**: `6222 **** **** 1234` (ä¿ç•™å‰4ä½å’Œå4ä½)

#### 1.2 äºŒçº§æ•æ„Ÿä¿¡æ¯ï¼ˆæ¡ä»¶è„±æ•ï¼‰
- **é‚®ç®±åœ°å€**: `user***@domain.com` (ç”¨æˆ·åéƒ¨åˆ†è„±æ•)
- **çœŸå®å§“å**: åœ¨éå¿…è¦åœºæ™¯ä¸‹ä½¿ç”¨æ˜µç§°ä»£æ›¿

### 2. è„±æ•å®ç°æ–¹æ¡ˆ

#### 2.1 æ‰‹æœºå·è„±æ•æœåŠ¡
```typescript
// åœ¨ src/utils/dataMasking.ts ä¸­å®ç°
export function maskPhoneNumber(phone: string): string {
  if (!phone || phone.length < 8) {
    return '';
  }
  
  // åŒ¹é…æ‰‹æœºå·ï¼š1[3-9]\d{9}
  const phoneRegex = /^1[3-9]\d{9}$/;
  if (!phoneRegex.test(phone)) {
    return '';
  }
  
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

export function maskIdCard(idCard: string): string {
  if (!idCard || idCard.length < 10) {
    return '';
  }
  
  return idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2');
}

export function maskBankCard(cardNumber: string): string {
  if (!cardNumber || cardNumber.length < 8) {
    return '';
  }
  
  return cardNumber.replace(/(\d{4})\d{8,12}(\d{4})/, '$1 **** **** $2');
}
```

#### 2.2 APIå“åº”è„±æ•ä¸­é—´ä»¶
```typescript
// åœ¨ src/middleware/dataMasking.ts ä¸­å®ç°
import { Request, Response, NextFunction } from 'express';
import { maskPhoneNumber, maskIdCard, maskBankCard } from '../utils/dataMasking';

interface SensitiveDataConfig {
  phone: boolean;
  idCard: boolean;
  bankCard: boolean;
  realName: boolean;
}

export function sensitiveDataMasking(config: SensitiveDataConfig) {
  return (req: Request, res: Response, next: NextFunction) => {
    const originalJson = res.json;
    
    res.json = function(data: any) {
      if (data && typeof data === 'object') {
        const maskedData = applyMasking(data, config);
        return originalJson.call(this, maskedData);
      }
      return originalJson.call(this, data);
    };
    
    next();
  };
}

function applyMasking(data: any, config: SensitiveDataConfig): any {
  if (Array.isArray(data)) {
    return data.map(item => applyMasking(item, config));
  }
  
  if (data && typeof data === 'object') {
    const masked = { ...data };
    
    if (config.phone && masked.phone) {
      masked.phone = maskPhoneNumber(masked.phone);
    }
    
    if (config.idCard && masked.idCard) {
      masked.idCard = maskIdCard(masked.idCard);
    }
    
    if (config.bankCard && masked.bankCard) {
      masked.bankCard = maskBankCard(masked.bankCard);
    }
    
    if (config.realName && masked.realName) {
      masked.realName = masked.nickname || '***';
    }
    
    return masked;
  }
  
  return data;
}
```

## ğŸ” æ•æ„Ÿä¿¡æ¯æŸ¥çœ‹å®¡è®¡

### 1. å®¡è®¡æ•°æ®è¡¨ç»“æ„

#### 1.1 æ•æ„Ÿä¿¡æ¯æŸ¥çœ‹è®°å½•è¡¨
```sql
-- åœ¨æ•°æ®åº“è¿ç§»æ–‡ä»¶ä¸­åˆ›å»º
CREATE TABLE sensitive_data_access_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(50) NOT NULL COMMENT 'æŸ¥çœ‹è€…ç”¨æˆ·ID',
  target_user_id VARCHAR(50) NOT NULL COMMENT 'è¢«æŸ¥çœ‹ç”¨æˆ·ID',
  data_type ENUM('phone', 'id_card', 'bank_card', 'real_name') NOT NULL COMMENT 'æ•æ„Ÿæ•°æ®ç±»å‹',
  access_reason VARCHAR(200) NOT NULL COMMENT 'æŸ¥çœ‹åŸå› ',
  ip_address VARCHAR(45) NOT NULL COMMENT 'IPåœ°å€',
  user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'è®¿é—®æ—¶é—´',
  INDEX idx_user_id (user_id),
  INDEX idx_target_user_id (target_user_id),
  INDEX idx_data_type (data_type),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ•æ„Ÿä¿¡æ¯æŸ¥çœ‹å®¡è®¡æ—¥å¿—';
```

### 2. å®¡è®¡æœåŠ¡å®ç°

#### 2.1 å®¡è®¡æ—¥å¿—æœåŠ¡
```typescript
// åœ¨ src/services/auditService.ts ä¸­å®ç°
import { prisma } from '../config/database';

export interface SensitiveAccessLog {
  userId: string;
  targetUserId: string;
  dataType: 'phone' | 'id_card' | 'bank_card' | 'real_name';
  accessReason: string;
  ipAddress: string;
  userAgent?: string;
}

export class AuditService {
  /**
   * è®°å½•æ•æ„Ÿä¿¡æ¯æŸ¥çœ‹æ—¥å¿—
   */
  static async logSensitiveDataAccess(logData: SensitiveAccessLog): Promise<void> {
    try {
      await prisma.sensitiveDataAccessLog.create({
        data: {
          user_id: logData.userId,
          target_user_id: logData.targetUserId,
          data_type: logData.dataType,
          access_reason: logData.accessReason,
          ip_address: logData.ipAddress,
          user_agent: logData.userAgent || '',
        },
      });
    } catch (error) {
      console.error('Failed to log sensitive data access:', error);
      // å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥ä¸åº”è¯¥å½±å“ä¸»è¦ä¸šåŠ¡é€»è¾‘
    }
  }

  /**
   * æŸ¥è¯¢æ•æ„Ÿä¿¡æ¯è®¿é—®å†å²
   */
  static async getAccessHistory(
    targetUserId: string,
    dataType?: 'phone' | 'id_card' | 'bank_card' | 'real_name',
    limit: number = 50
  ) {
    const where: any = {
      target_user_id: targetUserId,
    };
    
    if (dataType) {
      where.data_type = dataType;
    }
    
    return await prisma.sensitiveDataAccessLog.findMany({
      where,
      orderBy: { created_at: 'desc' },
      take: limit,
      include: {
        user: {
          select: {
            id: true,
            username: true,
          },
        },
      },
    });
  }

  /**
   * è·å–æ•æ„Ÿä¿¡æ¯è®¿é—®ç»Ÿè®¡
   */
  static async getAccessStatistics(startDate: Date, endDate: Date) {
    const logs = await prisma.sensitiveDataAccessLog.groupBy({
      by: ['data_type'],
      where: {
        created_at: {
          gte: startDate,
          lte: endDate,
        },
      },
      _count: {
        id: true,
      },
    });

    return logs.map(log => ({
      dataType: log.data_type,
      accessCount: log._count.id,
    }));
  }
}
```

#### 2.2 æ•æ„Ÿä¿¡æ¯è®¿é—®ä¸­é—´ä»¶
```typescript
// åœ¨ src/middleware/sensitiveDataAccess.ts ä¸­å®ç°
import { Request, Response, NextFunction } from 'express';
import { AuditService } from '../services/auditService';

export function validateSensitiveDataAccess(
  dataType: 'phone' | 'id_card' | 'bank_card' | 'real_name'
) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const requesterId = req.user?.id;
    const targetUserId = req.params.userId || req.body.targetUserId;
    const accessReason = req.body.reason || 'ç”¨æˆ·è¯·æ±‚';

    if (!requesterId || !targetUserId) {
      return res.status(400).json({
        code: 400,
        message: 'ç¼ºå°‘å¿…è¦å‚æ•°',
      });
    }

    // æƒé™æ£€æŸ¥ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•æ„Ÿä¿¡æ¯æˆ–ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
    if (requesterId !== targetUserId && req.user?.role !== 'admin') {
      return res.status(403).json({
        code: 403,
        message: 'æ— æƒæŸ¥çœ‹ä»–äººæ•æ„Ÿä¿¡æ¯',
      });
    }

    // è®°å½•è®¿é—®æ—¥å¿—
    await AuditService.logSensitiveDataAccess({
      userId: requesterId,
      targetUserId,
      dataType,
      accessReason,
      ipAddress: req.ip || req.connection.remoteAddress || '',
      userAgent: req.get('User-Agent'),
    });

    next();
  };
}
```

## ğŸ“Š APIæ¥å£è®¾è®¡

### 1. æ•æ„Ÿä¿¡æ¯è·å–æ¥å£

#### 1.1 è·å–çœŸå®æ‰‹æœºå·
```typescript
// åœ¨ src/routes/userRoutes.ts ä¸­å®ç°
router.get(
  '/users/:userId/real-phone',
  authenticateToken,
  validateSensitiveDataAccess('phone'),
  async (req: Request, res: Response) => {
    try {
      const { userId } = req.params;
      const user = await UserService.getUserById(userId);
      
      if (!user?.phone) {
        return res.status(404).json({
          code: 404,
          message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–æœªè®¾ç½®æ‰‹æœºå·',
        });
      }

      res.json({
        code: 200,
        data: {
          phone: user.phone,
          masked: false,
        },
        message: 'è·å–æˆåŠŸ',
      });
    } catch (error) {
      res.status(500).json({
        code: 500,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      });
    }
  }
);
```

### 2. å®¡è®¡æŸ¥è¯¢æ¥å£

#### 2.1 è·å–è®¿é—®å†å²
```typescript
router.get(
  '/audit/sensitive-data/:userId',
  authenticateToken,
  async (req: Request, res: Response) => {
    try {
      const { userId } = req.params;
      const { dataType, limit } = req.query;

      // æƒé™æ£€æŸ¥ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¿é—®å†å²æˆ–ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
      if (req.user?.id !== userId && req.user?.role !== 'admin') {
        return res.status(403).json({
          code: 403,
          message: 'æ— æƒæŸ¥çœ‹ä»–äººè®¿é—®å†å²',
        });
      }

      const history = await AuditService.getAccessHistory(
        userId,
        dataType as any,
        parseInt(limit as string) || 50
      );

      res.json({
        code: 200,
        data: history,
        message: 'æŸ¥è¯¢æˆåŠŸ',
      });
    } catch (error) {
      res.status(500).json({
        code: 500,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      });
    }
  }
);
```

## ğŸ›¡ï¸ å®‰å…¨æªæ–½

### 1. è®¿é—®æ§åˆ¶
- JWT TokenéªŒè¯
- è§’è‰²æƒé™æ£€æŸ¥ï¼ˆadmin/userï¼‰
- æ•æ„Ÿæ“ä½œäºŒæ¬¡ç¡®è®¤

### 2. æ•°æ®ä¼ è¾“å®‰å…¨
- HTTPSåŠ å¯†ä¼ è¾“
- APIè¯·æ±‚é¢‘ç‡é™åˆ¶
- æ•æ„Ÿæ•°æ®è„±æ•å“åº”

### 3. å®¡è®¡åˆè§„
- æ‰€æœ‰æ•æ„Ÿä¿¡æ¯è®¿é—®å®Œæ•´è®°å½•
- å®šæœŸå®¡è®¡æ—¥å¿—åˆ†æ
- å¼‚å¸¸è®¿é—®è¡Œä¸ºç›‘æ§å‘Šè­¦

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. å‰ç«¯é›†æˆ
```typescript
// å‰ç«¯è°ƒç”¨æ•æ„Ÿä¿¡æ¯æ¥å£ç¤ºä¾‹
const getRealPhone = async (userId: string) => {
  try {
    const response = await api.get(`/users/${userId}/real-phone`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
      data: {
        reason: 'ç”¨æˆ·ä¸»åŠ¨æŸ¥çœ‹',
      },
    });
    
    if (response.data.code === 200) {
      return response.data.data.phone;
    }
  } catch (error) {
    console.error('è·å–æ‰‹æœºå·å¤±è´¥:', error);
  }
};
```

### 2. é”™è¯¯å¤„ç†
```typescript
// å¸¸è§é”™è¯¯ç è¯´æ˜
const ERROR_CODES = {
  403: 'æ— æƒæŸ¥çœ‹ä»–äººæ•æ„Ÿä¿¡æ¯',
  429: 'è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•',
  500: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
};
```

## ğŸ”„ ç»´æŠ¤å’Œç›‘æ§

### 1. å®šæœŸæ£€æŸ¥
- å®¡è®¡æ—¥å¿—å®Œæ•´æ€§æ£€æŸ¥
- æ•æ„Ÿæ•°æ®è®¿é—®æ¨¡å¼åˆ†æ
- å¼‚å¸¸è®¿é—®è¡Œä¸ºå‘Šè­¦

### 2. æ•°æ®æ¸…ç†
- å®¡è®¡æ—¥å¿—å®šæœŸå½’æ¡£ï¼ˆå»ºè®®ä¿ç•™1å¹´ï¼‰
- æ•æ„Ÿæ•°æ®ç¼“å­˜å®šæœŸæ¸…ç†

æ­¤æ–‡æ¡£ç¡®ä¿äº†ä¿¡æ¯è„±æ•å’Œæ•æ„Ÿä¿¡æ¯æŸ¥çœ‹çš„å®Œæ•´æ€§å’Œåˆè§„æ€§ï¼Œä¸ºç³»ç»Ÿå®‰å…¨æä¾›äº†åšå®çš„ä¿éšœã€‚